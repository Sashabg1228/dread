\section{Софтуерна реализация на библиотеката на радиочестотния модул}
\label{sec:library}

Безжичната комуникация между дистанционното и бойния робот се осъществава посредством радиочестотния модул nRF24L01 на компанията Nordic. За целите на дипломния проект не беше употребявана готова библиотека за управление на избрания модул, а беше разработена собствена такава. За нейната реализация са употребявани функционалностите на вградената HAL библиотека. С цел улеснение на написването на библиотеката, в хедър файла \textbf{????}\footnote{Превод?} са дефинирани като макроси адресите в паметта на регистрите и SPI командните думи. За да може библиотеката да работи, предварително трябва да бъде конфигуриран SPI интерфейса и пиновете, които се използват nRF модула. С цел улеснение на работата с библиотеката е предвидено предварително изводите на радиочестотния модул да имат зададени потребителските етикети NRF24L01\_CSN, NRF24L01\_CE и NRF24L01\_IRQ на съответните им пинове на микроконтролера.

Основните функционалности, които трябва да бъдат реализирани, за да може библиотеката да бъде разработена са писане и четене на регистрите на радиочестотния модул. За да се пише в регистър се подготвя масив с дължина 2 байта. В първия се поставя номера на регистъра, а във втория стойността, която трябва да бъде записана. За да може nRF модула да разбере, че трябва да запише получената стойност, трябва да бъде поставена единица на 5-та позиция от първия байт. Съгласно секция 8.3. "SPI комуникация" от документацията на nRF24L01 всяка SPI операция трябва да бъде започната с падащ фронт на CSN извода на радиочестотния модул. След това се извиква HAL функцията за предаване на информация по SPI интерфейса.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={37-51}, caption={Писане в регистър}, label={lst:write-register}]{documents/rf-library/NRF24L01.c}

Четенето на регистър се реализира аналогично. При него не се подготвя масив, в който да се постави адреса на регистъра и той не бива редактиран. Вместо това първо се използва HAL функцията за предаване на номера на регистъра, който трябва да бъде прочетен, и след това се използва HAL функцията за получаване на данни по SPI.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={72-87}, caption={Четене на регистър}, label={lst:read-register}]{documents/rf-library/NRF24L01.c}

Основната част от регистрите в паметта на използвания nRF модул са с размер 1 байт, но тези, които съхраняват адреси за каналите за комуникация 0 и 1 имат 5 пъти по-голяма дължина. Поради тази причина са написани функциите nrf24\_write\_reg\_multi() и nrf24\_read\_reg\_multi(), които съответно могат да бъдат видени на \autoref{lst:write-big-register} и \autoref{lst:read-big-register}. Те са реализирани аналогично на по-малките им подобни функции.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={52-70}, caption={Писане на големи регистри}, label={lst:write-big-register}]{documents/rf-library/NRF24L01.c}

\lstinputlisting[language=c, consecutivenumbers=false, linerange={88-99}, caption={Четене на големи регистри}, label={lst:read-big-register}]{documents/rf-library/NRF24L01.c}


%================================================================================
% ИНИЦИАЛИЗАЦИЯ

\subsection{Инициализация на модула}
\label{ssec:init}

При получаване на захранване първата задача на микроконтролера и радио модула е да бъдат конфигурирани. Инициализацията на първия може да бъде видяна в \cref{ssec:init-controller} и \cref{ssec:init-robot}. Привеждането на радиочестотния модул в състояние, което позволява безжично предаване на информация е осъществено като се извикват една след друга първо функцията за инициализация на модула и след това и допълнителна такава, с която се пояснява дали същия е предавател или получател на информацията.

При началото на инициализацията на CE пина се подава ниско ниво за да се гарантира, че няма да се активира механизма за изпращане на данни. След това се подават зануляват стойностите на CONFIG и RF\_CH регистрите. Те следва да бъдат редактирани при задаването на роля на модула \textbf{????}\footnote{????}. Чрез записване на 0 в EN\_AA регистъра се изключват автоматичните потвърждения по време на безжичното предаване. В регистъра EN\_RXADDR стойността 0 спира употребата на 6-те информационни канала \textbf{????}\footnote{data pipe}. За да се дефинира дължината на адреса да бъде 5 байта в регистъра SETUP\_AW са поставени единици на битове 0 и 1. Последния регистър, който се конфигурира в рамките на тази функция е RF\_SETUP. Чрез поставяне на 0 на 3 бит в него се задава скоростта на предаване на информация да бъде 1Mbps, а посредством единици на битове 1 и 2, мощността на предаване на изхода на радиото е 0dBm. 

\lstinputlisting[language=c, consecutivenumbers=false, linerange={145-159}, caption={Инициализация на радио модула}, label={lst:init}]{documents/rf-library/NRF24L01.c}

След функцията за инициализиране на nRF модула се извиква функция, която да пояснява дали модула е предавател или получател на данни. В \autoref{lst:conf-transmitter} може да бъде видяна процедурата за конфигуриране предавател. Първо се задава в регистър RF\_CH честотата (канала), на която ще се предава информацията. След това се записва 5 байтовия адрес на получателя в TX\_ADDR регистъра. После без да се редактира останалата част от регистъра в CONFIG се поставят единица на бит 1 и се оставя нула на бит 0 съответно за да се стартира дейността на радиочестотния модул и за да се влезе в режим на изпращач на информация. 

\lstinputlisting[language=c, consecutivenumbers=false, linerange={164-174}, caption={Конфигуриране на изпращач на данни}, label={lst:conf-transmitter}]{documents/rf-library/NRF24L01.c}

Подобно на последно разглежданата функция NRF24\_RX\_mode() започва със задаване на честотата на предаване на информация. След това без да се редактира останалата част от регистъра EN\_RXADDR се поставя единица на бит 1 поради за да се позволи употребата на информационен канал 1. После се записва 5 байтовия адрес на изпращача на информация в RX\_ADDR\_P1 регистъра. За да се дефинира дължината на пакета данни, който ще се изпраща безжично, се записва големината на структурата Payload в регистъра RX\_PW\_P1. След това без да се реактира останалата му част в CONFIG регистъра се поставят единици на битове 0 и 1 съответно за да се стартира дейността на радиочестотния модул и за да се влезе в режим на получател на данни. В края на тази функция CE пина бива поставен във високо състояние и се държи в това през целия период на работа. В случай, че CE мине в ниско ниво, nRF модула ще излезе от режима на получател.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={234-256}, caption={Конфигуриране на получател на данни}, label={lst:conf-receiver}]{documents/rf-library/NRF24L01.c}

Стойностите, които са избрани за скорост на безжичното предаване, мощността на предаване на изхода на nRF модула и честотата на излъчване на сигнали са подбрани такива, че да осигуряват максимален обхват на безжичната комуникация.

%================================================================================
% ИЗПРАЩАНЕ НА ДАННИ

\subsection{Изпращане на информация}
\label{ssec:transmit}

Изпращането на пакет инструкции от дистанционното към робота се извършва посредством функцията NRF24\_transmit(). Първата стъпка от нейното изпълнение е пакета с инструкции да бъде зареден в паметта на радио модула, посредством функцията, която може да бъде видяна в \autoref{lst:push-payload}. След това се генерира импулс на CE извода по-дълъг от 10us. Съгласно секция 6.1.5. "режим предаване" от документацията на nRF24L01 при такъв импулс в режима за изпращане на данни, записаните в паметта на модула пакети инструкции започват да се излъчват. Останалата част на функцията проверява дали пакетите са били изпратени успешно като проверява съдържанието на FIFO\_STATUS регистъра. Ако четвъртият бит в него е вдигнат означава, че пакета е бил успешно изпратен.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={204-228}, caption={Изпращане на пакет инструкции}, label={lst:transmit}]{documents/rf-library/NRF24L01.c}

Когато се зарежда пакет инструкции в паметта на радиочестотния модул, първо се проверява дали пакета не е твърде голям. В случай, че е опита за безжично изпращане на инструкциите бива прекратен. Останалата част от зареждането на пакета наподобява значително функциите за писане в регистри. Първо се заделя масив от еднобайтови променливи. След това на първа позиция в масива се записва SPI командата за записване на пакета в паметта на модула и чрез функцията memcpy() се записва съдържанието на пакета в масива от втория елемент нататък. Както беше споменато в предишната секция следва да се направи падащ фронт на пин CSN. Когато буфера е вече готов, той бива зареден в паметта, чрез HAL функцията за предаване на информация по SPI интерфейса. Накрая функцията завършва като CSN пина ве върне в свойто предишно състояние.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={175-202}, caption={Зареждане на пакет инструкции}, label={lst:push-payload}]{documents/rf-library/NRF24L01.c}

%================================================================================
% ПОЛУЧАВАНЕ НА ДАННИ

\subsection{Получаване на информация}
\label{ssec:receive}

Получаването на пакети с инструкции се реализира чрез две функции. Първата проверява дали има нова получена информация в радио модула, а втората е същинското и извличане в паметта на микроконтролера. Проверката се осъществява като се прочита STATUS регистъра. Ако бит 6 е единица следва, че има получени нови команди, а в битове 1, 2 и 3 е запазен номера на информационния канал, от който е получената информация. След това стойността на същия регистър се рестартира и функцията връща резултат, показващ, че има получени данни. 

\lstinputlisting[language=c, consecutivenumbers=false, linerange={256-273}, caption={Проверка дали има получен пакет инструкции}, label={lst:check-delivered}]{documents/rf-library/NRF24L01.c}

Във функцията за извличане на данни първата първо се дефинират двата помощни масива. В първия се записва SPI командата R\_RX\_PAYLOAD, която се използва за да се извлече получения нов пакет информация, а във втория следва тя да се бъде записана. След това посредством HAL функцията за предаване и получаване на информация по SPI интерфейса командата се изпраща до радиочестотния модул и сеполучава резултата във втория помощен масив. После чрез функцията memcpy() информацията се премества от помощния регистър в желаната променлива.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={275-299}, caption={Получаване на пакет инструкции}, label={lst:receive}]{documents/rf-library/NRF24L01.c}

