\section{Софтуерна реализация на управлението на робота}
\label{sec:software-robot}

%================================================================================
% ИНИЦИАЛИЗАЦИЯ

\subsection{Инициализация на микроконтролера на робота}
\label{ssec:init-robot}

След като получи захранването си микроконтролера преминава през серия от процеси, които трябва да конфигурират използваните периферии, изводи и променливи. Посредством функцията HAL\_Init() се рестартират всички периферии и се инициализират HAL библиотеката и всички нейни функционалности. След това чрез SystemClock\_Config() се конфигурира системния таймер. После следва конфигурацията на изводите на микроконтролера. Една от тях може да бъде видяна в \autoref{lst:conf-pin-robot}. За това кой пин как е конфигуриран и за какво се използва може да се разбере от таблица \cref{table:pins-robot}. След това се инициализира SPI връзката с nRF модула. Чрез функциите MX\_TIM3\_Init(), MX\_TIM2\_Init() и MX\_TIM4\_Init() се инициализират таймери 2, 3 и 4. Таймер 3 се използва за генериране широчинно импулсен сигнал за контролиране на скоростта на въртене на четковите мотори, а 4-тия се използва за измерване на тяхната скорост. Таймер 2 се използва за генерирането на импулси за движението на робота. След това се инициализира радиочестотния модул и се задава неговия режим на робота. Чрез функцията HAL\_TIM\_PWM\_Start() се стартира генерирането на широчинно импулсния сигнал. Преди да започне повтарящият се цикъл на работа и таймери 2 и 4 се стартират.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={72-76}, caption={Конфигуриране на пин}, label={lst:conf-pin-robot}]{documents/controller/gpio.c}

\begin{table}[H]
    \centering
    \begin{tabular}{| m{4cm} | m{3,5cm} | m{3,5cm} | m{3,5cm} |}
        \hline
        & Wi-fi & Bluetooth & nRF24L01+ \\
        \hline
        Скорост &  Висока & Средно & Средна \\
        \hline
        Обхват & 10ки метри & 10 метра & 10-150 метра \\
        \hline
        Енергийна консумация & Висока & Средна & Ниска\\
        \hline
    \end{tabular}
    \caption{Пинове}
    \label{table:pins-robot}
\end{table}

%================================================================================
% РАБОТЕН ЦИКЪЛ

\subsection{Работен цикъл на робота}
\label{ssec:loop-robot}

Както е описано в \cref{sec:logic-schemas} цикъла на работа започва с проверка на това дали има получен нов пакет инструкции. Ако има получен такъв се извиква функцията за извличане на данните от радиочестотния модул и ако е успешна се извиква функцията, която прилага инструкциите.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={122-135}, caption={Работен цикъл}, label={lst:loop-robot}]{documents/robot/robot.c}

Функцията за прилагането на инструкциите е съставена от помощни функции. Първо чрез функцията get\_brushed\_DIR() се проверява в коя посока кой от четковите мотори трябва да се върти и се задава съответната стойност на съответния извод. След това посредством get\_brushed\_DIR() се задава какъв трябва да бъде коефициента на запълване на широчинно-импулсния сигнал, който се използва за дава каква трябва да бъде скоростта на въртене на четковите мотори.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={249-280}, caption={Управление на четковите мотори}, label={lst:dc-motor}]{documents/robot/robot.c}

Последната функция, която се извиква във функцията unload\_payload() се казва get\_hand\_DIR(). Тя се използва за да се определя посоката на движение на стъпковия мотор. Импулсите за колко стъпки да бъдат направени се генерират чрез прекъсването при преливане на таймер 2. Функцията за обработка на прекъсването може да бъде видяна в \cref{lst:overflow-interupts}.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={282-297}, caption={Управление на стъпковия мотор}, label={lst:stepper-motor}]{documents/robot/robot.c}

%================================================================================
% СЕНЗОРИ ЗА ОБРАТНА ВРЪЗКА

\subsection{Сензори за обратна връзка}
\label{ssec:feedback-sensors}

Съгласно изискванията за безопасност описани в \cref{sec:requirements} са имплементирани и двата крайни изключвателя за ръката. Те са свързани към изводи на микроконтролера, за които има конфигурирани външни прекъсвания, които се генерират при падащ и нарастващ фронт на вълната. Когато такова прекъсване се появи се вдига флаг, който спира работата на движението на ръката докато ръката не отвори отново крайния изключвател. 

\lstinputlisting[language=c, consecutivenumbers=false, linerange={184-209}, caption={Външни прекъсвания}, label={lst:external-interupts}]{documents/robot/robot.c}

В проекта има монтирани и оптични сензори, чрез които се следи приблизителната скорост на четковите мотори. Тази функционалност е реализирана посредством външни прекъсвания и прекъсване при преливане. При генерирането на първото се увеличава променлива, която съдържа броя завъртания на съответния мотор. Чрез прекъсването при преливане на таймер 4, на равни интервали от време, се проверява дали има направени завъртания за текущия период. Ако няма направени следва да бъде забранено на съответния мотор да се върти известно време.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={211-247}, caption={Прекъсвания при преливане}, label={lst:overflow-interupts}]{documents/robot/robot.c}
