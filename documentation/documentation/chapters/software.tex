\chapter{Софтуерна реализация}
\label{chap:software}
% TODO: ask Garistov if 1/4 sec is enough for magic smoke to appear
% TODO: ask Garistov what to do with the messed up interupts
Използваната среда за разработка на софтуерната част от дипломния проект е софтуерния пакет STM32CubbeIDE на STMicroelectronics. Тази платформа е предназначена за изграждане на софтуерното управление на STM микроконтролери и микропроцесори. Чрез интеграцията на GNU GCC компилатор и GBD дебъгер, тя предоставя стабилна среда за разработка на C/C++ програми. В STM32CubbeIDE е интегриран и графичния инструмент STM32CubeMX. Той улеснява конфигурацията и инициализацията на различни части и периферии на микроконтролерите, сред които са пинове, таймери, системни прекъсвания и DMA заявки. Друга основна характеристика на избраната среда за разработка е възможността за подробен дебъгване чрез мониторинг на процесорните ядра, регистрите на периферията, паметта и заделените променливи и други. Софтуерният пакет може да бъде свален безплатно от сайта на STMicroelectronics за 64-битовите версии на операционните системи Windows, Linux и macOS. Поради споменатите причини тази среда за разработка беше използвана за проекта.


%================================================================================
% ЛОГИЧЕСКА СХЕМА  -  РОБОТ

\section{Логическа схема на проекта}
\label{sec:logic-schemas}

Съгласно заданието на дипломния проект разработеният боен робот бива управляван посредством специално изработено дистанционно. Комуникацията между тях бива реализирана посредством радиочестотните модули nRF24L01 на компанията Nordic. Те използват вградения си протокол за комуникация Enhanced ShockBurst, който е предназначен за лесна комуникация с ниска енергийна консумация.

Като се получи захранване микроконтролера и радиочестотния модул в дистанционното биват инициализирани. След това започва непрекъснато повтарящият се на равни интерваи цикъл на работа. Първо се прочитат входните данни от потенциометрите и бутоните. След това те биват обработени и записани в подходящ вид. В края на този цикъл обработените потребителски команди биват записани в пакет с инструкции за контрол на бойния робот и той бива изпратен към батълбота за изпълнение. После цикъла на работа на дистанционното започва да се изпълнява отначало. Микроконтролерът е настроен да може да бъдат изпращани по 20 пакета с команди в секунда. Това скорост гарантира на пилота възможността да може да управлява своята машина с минимално системно забавяне.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{images/logic-schema-controller.png}
    
    \caption{Логическа схема на дистанционното}
    \label{fig:logic-controller} 
\end{figure}

Полетата, които се съдържат в изпратения пакет са инструкция за позицията, на която трябва да застане механичната ръка на робота, инструкции за скоростта и посоката на въртене на двете колела и инструкция за това дали оръжието трябва да се върти. Структурата на такъв пакет може да бъде видяна на \autoref{lst:payload}.

\lstinputlisting[language=c, consecutivenumbers=false, linerange={11-17}, caption={Пакет инструкции}, label={lst:payload}]{documents/rf-library/NRF24L01.h}

Подобно на дистанционното първата работа на печатната платка, когато получи захранване е да се инициализират микроконтролера и радиочестотния модул. След това започва непрекъснат цикъл на проверяване дали има получен пакет инструкции и ако има се прави опит той да бъде достъпен. При успешното им прочитане те биват заредени в паметта на платката и биват изпълнени. След тази стъпка следва повторно започване на работния цикъл на робота. В случаите, в които няма получени инструкции или не бъде успешно тяхното прочитане, цикъла на работа започва отначало и се спира движението на робота.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{images/logic-schema-robot.png}
    
    \caption{Логическа схема на робота}
    \label{fig:logic-robot} 
\end{figure}


%================================================================================
% СОФТУЕР  -  РАДИО

\input{chapters/sections/software-library}

%================================================================================
% СОФТУЕР  -  ДИСТАНЦИОННО

\input{chapters/sections/software-controller}

%================================================================================
% СОФТУЕР  -  РОБОТ

\input{chapters/sections/software-robot}

